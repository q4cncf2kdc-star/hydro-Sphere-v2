<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hydro Sphere Ultimate</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        
        /* HUD */
        #hud {
            position: absolute; top: 20px; left: 20px;
            color: #00aaff; font-size: 12px; pointer-events: none; z-index: 10;
            background: rgba(0, 10, 20, 0.5); padding: 10px; border-radius: 8px;
            border: 1px solid rgba(0, 170, 255, 0.2);
        }
        
        /* Settings Button */
        #settings-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 20, 40, 0.6); color: #00aaff;
            border: 1px solid #00aaff; padding: 8px; border-radius: 8px;
            cursor: pointer; z-index: 20; font-size: 20px;
        }

        /* Settings Panel */
        #settings-panel {
            position: absolute; top: 60px; right: 20px; width: 280px;
            background: rgba(5, 15, 25, 0.9); backdrop-filter: blur(10px);
            border: 1px solid #00aaff; border-radius: 12px; padding: 15px;
            display: none; color: #fff; z-index: 20;
        }
        .control-group { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; color: #aaa; }
        input[type="range"] { width: 100%; accent-color: #00aaff; height: 4px; }
        .val-disp { color: #00aaff; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; float: right; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00aaff; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Start Overlay */
        #overlay {
            position: absolute; inset: 0; background: #000; z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }
        #start-btn {
            padding: 15px 40px; background: #00aaff; color: #000; border: none;
            font-weight: bold; font-size: 16px; border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 25px rgba(0,170,255,0.5);
        }
    </style>
</head>
<body>

<div id="hud">
    <div>Hydro Sphere</div>
    <div style="opacity:0.7; margin-top:4px">Double-tap to splash</div>
    <div style="margin-top:4px">FPS: <span id="fps">60</span></div>
    <div style="margin-top:4px">● Audio: <span id="audio-level">0%</span></div>
</div>

<button id="settings-btn">⚙️</button>

<div id="settings-panel">
    <h3 style="color:#00aaff; margin-bottom:15px; font-size:14px; text-transform:uppercase;">Settings</h3>
    
    <div class="control-group">
        <label>Microphone Audio <label class="switch"><input type="checkbox" id="mic-toggle"><span class="slider"></span></label></label>
    </div>

    <div class="control-group">
        <label>Animation Speed <span id="speed-val" class="val-disp">1.00x</span></label>
        <input type="range" id="speed" min="0" max="3" step="0.1" value="1.0">
    </div>

    <div class="control-group">
        <label>Splash Intensity <span id="splash-val" class="val-disp">1.5</span></label>
        <input type="range" id="splash" min="0.5" max="5.0" step="0.1" value="1.5">
    </div>

    <div class="control-group">
        <label>Surface Tension <span id="tension-val" class="val-disp">1.00</span></label>
        <input type="range" id="tension" min="0.1" max="2.0" step="0.1" value="1.0">
    </div>

    <div style="margin-top:10px; font-size:10px; color:#555; text-align:center;">
        v2.0 Mobile Optimized • WebGPU
    </div>
</div>

<div id="overlay"><button id="start-btn">TAP TO START</button></div>

<script type="importmap">
{
    "imports": {
        "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/",
        "three/tsl": "https://unpkg.com/three@0.170.0/examples/jsm/nodes/Nodes.js"
    }
}
</script>

<script type="module">
    import * as THREE from 'three';
    import { WebGPURenderer } from 'three/addons/renderers/webgpu/WebGPURenderer.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { 
        timerLocal, vec3, color, positionLocal, normalLocal, 
        mix, sin, cos, dot, max, pow, float, uniform, length
    } from 'three/tsl';

    // -- VARS --
    let renderer, scene, camera, controls;
    let audioCtx, analyser, dataArray, isListening = false;
    let lastTap = 0;

    // -- UNIFORMS (Live Control) --
    const uTimeScale = uniform(1.0);
    const uSplash = uniform(0.0);    // For double-tap effect
    const uAudio = uniform(0.0);     // Mic level
    const uIntensity = uniform(1.5); // User setting
    const uTension = uniform(1.0);   // Surface smoothness

    // -- INIT --
    async function init() {
        if(!navigator.gpu) return alert("WebGPU Required");

        renderer = new WebGPURenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000);
        document.body.appendChild(renderer.domElement);

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
        camera.position.z = 3.2;

        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.0;
        controls.enablePan = false;

        // -- TSL SHADER --
        const t = timerLocal().mul(uTimeScale);
        const pos = positionLocal.toVar();
        
        // Dynamic Noise
        const noiseFreq = float(3.0).add(uAudio.mul(4.0));
        const noiseAmp = uIntensity.mul(0.1).add(uAudio.mul(0.2)).add(uSplash);
        
        // 3 Layer Noise for "Liquid" look
        const n1 = sin(pos.mul(noiseFreq).add(t));
        const n2 = cos(pos.mul(noiseFreq.mul(1.5)).sub(t.mul(1.2)));
        const n3 = sin(pos.yxz.mul(5.0).add(t.mul(2.0)));
        
        const displacement = n1.mul(n2).mul(n3).mul(noiseAmp);
        
        // Apply Displacement
        const newPos = positionLocal.add(normalLocal.mul(displacement));

        // Color & Lighting
        const deepColor = color(0x000510);
        const waterColor = color(0x0055aa);
        const foamColor = color(0xffffff);

        // Fresnel (Rim)
        const viewDir = camera.position.sub(newPos).normalize();
        const fresnel = float(1.0).sub(dot(normalLocal, vec3(0,0,1))).clamp(0,1).pow(uTension.mul(3.0));

        // Mixing
        let finalColor = mix(deepColor, waterColor, displacement.add(0.2).mul(2.0));
        finalColor = mix(finalColor, foamColor, fresnel.mul(0.8).add(uSplash.mul(2.0))); // Flash on splash

        const material = new THREE.MeshPhysicalNodeMaterial({
            colorNode: finalColor,
            positionNode: newPos,
            roughness: 0.05,
            metalness: 0.3,
            clearcoat: 1.0,
            clearcoatRoughness: 0.1
        });

        const sphere = new THREE.Mesh(new THREE.SphereGeometry(1, 128, 128), material);
        scene.add(sphere);

        // Lights
        const light = new THREE.DirectionalLight(0xffffff, 2);
        light.position.set(2, 2, 5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x112233, 1));

        animate();
    }

    // -- AUDIO LOGIC --
    async function toggleAudio(active) {
        if(active) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const src = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 64;
                src.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isListening = true;
            } catch(e) { 
                alert("Microphone denied"); 
                document.getElementById('mic-toggle').checked = false;
            }
        } else {
            isListening = false;
            if(audioCtx) audioCtx.close();
        }
    }

    // -- LOOP --
    let frames = 0, lastTime = performance.now();
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        
        // Audio processing
        if(isListening && analyser) {
            analyser.getByteFrequencyData(dataArray);
            let avg = 0;
            for(let i=0; i<dataArray.length; i++) avg += dataArray[i];
            const vol = Math.min(avg / 500, 1.0); // Normalize
            
            // Smooth lerp
            uAudio.value = uAudio.value * 0.9 + vol * 0.1;
            document.getElementById('audio-level').innerText = Math.round(uAudio.value * 100) + "%";
        } else {
            uAudio.value = 0;
        }

        // Splash decay
        if(uSplash.value > 0) uSplash.value *= 0.95;

        renderer.render(scene, camera);

        // FPS
        frames++;
        const now = performance.now();
        if(now - lastTime >= 1000) {
            document.getElementById('fps').innerText = frames;
            frames = 0; lastTime = now;
        }
    }

    // -- UI EVENTS --
    document.getElementById('start-btn').onclick = () => {
        document.getElementById('overlay').remove();
        init();
    };

    document.getElementById('settings-btn').onclick = () => {
        const panel = document.getElementById('settings-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    };

    // Sliders
    const linkSlider = (id, uniform, displayId, suffix='') => {
        document.getElementById(id).oninput = (e) => {
            const v = parseFloat(e.target.value);
            uniform.value = v;
            document.getElementById(displayId).innerText = v.toFixed(2) + suffix;
        };
    };

    linkSlider('speed', uTimeScale, 'speed-val', 'x');
    linkSlider('splash', uIntensity, 'splash-val');
    linkSlider('tension', uTension, 'tension-val');

    document.getElementById('mic-toggle').onchange = (e) => toggleAudio(e.target.checked);

    // Double Tap
    window.addEventListener('touchend', (e) => {
        const now = Date.now();
        if(now - lastTap < 300) {
            uSplash.value = 1.0; // Trigger splash
        }
        lastTap = now;
    });
    window.addEventListener('dblclick', () => uSplash.value = 1.0);
    window.addEventListener('resize', () => {
        if(camera) {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    });

</script>
</body>
</html>
